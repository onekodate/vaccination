import Head from 'next/head'
import styles from '../styles/Home.module.css';

export async function getStaticProps() {
    const res = await fetch("http://vrs-data.cio.go.jp/vaccination/opendata/latest/prefecture.ndjson");
    if(!res.ok) throw new Error();
    const text = (await res.text()).replace(/\n/g,",").replace(/,$/,"");
    const arr=JSON.parse("\["+text+"\]").map(val=>{
        return {
            age:val.age,
            count:val.count,
            date:val.date,
            gender:val.gender,
            pref:Number(val.prefecture),
            status:val.status,
        };
    });
    console.log(arr.length);
    return {
        props:{
            arr
        },
        revalidate:1,
    };
}

function Home(props){
    if(props){
        const str=JSON.stringify(props.arr);
//        return (<div>{str.slice(0,1000)}</div>)
        const button=(event)=>{
            const arr=event.target.value.split(",");
            if(arr[1]=="true") arr[1]=true;
            else if(arr[1]=="false") arr[1]=false;
            setting[arr[0]]=arr[1];
            if(result){
                if(["popup","pref"].includes(arr[0])){
                    popup();
                }else if(arr[0]=="ranking"){
                    map2();
                }else{
                    ranking();
                    map2();
                }
                if(elem("popup").className=="popup") popup();
            }else console.log(setting);
        }
        const close=()=>{
            elem("popup").className="invisible";
        }
        return (
            <div className={styles.container}>
                <Head>
                    <title>Vaccination</title>
                    <meta name="description" content="Generated by create next app" />
                    <link rel="stylesheet" href="https://onekodate.web.fc2.com/vaccination.css"/>
                    <script src="https://d3js.org/d3.v6.js"></script>
                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                    <script src="https://onekodate.web.fc2.com/vaccination.js"></script>
                <script>
                    result={str};
                    start();
                </script>
                </Head>
                <div className="body">
                    <div className="menu">
                        <label><input type="radio" name="count"     onChange={button} value="count,false"   id="count"  ></input><em>æ¯”ç‡</em></label>
                        <label><input type="radio" name="count"     onChange={button} value="count,true"                ></input><em>å›æ•°</em></label><br></br>
                        <label><input type="radio" name="density"   onChange={button} value="density,false" id="density"></input><em>ç´¯ç©</em></label>
                        <label><input type="radio" name="density"   onChange={button} value="density,true"              ></input><em>æ—¥åˆ¥</em></label><br></br>
                        <label><input type="radio" name="gender"    onChange={button} value="gender,Both"   id="gender" ></input><em>å…¨æ€§åˆ¥</em></label>
                        <label><input type="radio" name="gender"    onChange={button} value="gender,M"                  ></input><em>ç”·æ€§</em></label>
                        <label><input type="radio" name="gender"    onChange={button} value="gender,F"                  ></input><em>å¥³æ€§</em></label><br></br>
                        <label><input type="radio" name="age"       onChange={button} value="age,all"       id="age"    ></input><em>å…¨å¹´é½¢</em></label>
                        <label><input type="radio" name="age"       onChange={button} value="age,65-"                   ></input><em>65+</em></label>
                        <label><input type="radio" name="age"       onChange={button} value="age,-64"                   ></input><em>64-</em></label><br></br>
                        <label><input type="radio" name="status"    onChange={button} value="status,0"                  ></input><em>ç·å›æ•°</em></label>
                        <label><input type="radio" name="status"    onChange={button} value="status,1"                  ></input><em>1å›ç›®</em></label>
                        <label><input type="radio" name="status"    onChange={button} value="status,2"      id="status" ></input><em>2å›ç›®</em></label><br></br>    
                    </div>
                    <div className="main">
                        <p>éƒ½é“åºœçœŒãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®ãƒ©ãƒ³ã‚­ãƒ³ã‚°<b id="up_date"></b></p>
                        <table className="ranking">
                            <thead>
                                <tr>
                                    <th>#</th><th> </th><th> </th><th>éƒ½é“åºœçœŒ</th><th><a onClick={button} value="count,true">å›æ•°</a></th><th><a onClick={button} value="count,false">æ¯”ç‡</a></th>
                                </tr>
                            </thead>
                            <tbody id="table">
                                <tr>
                                    <th>1</th><th>â†‘</th><th>æ±äº¬éƒ½</th><th>18%</th><th>120äºº</th>
                                </tr>
                            </tbody>
                        </table>
                        <p>
                            <label><input type="radio" name="ranking" onChange={button} value="ranking,false"></input><em>çµ¶å¯¾æ•°</em></label>
                            <label><input type="radio" name="ranking" onChange={button} value="ranking,true" id="ranking"></input><em>é †ä½</em></label><br></br>
                        </p>
                        <div id="map2"></div>
                        <div className="invisible" id="popup"> 
                            <p><b id="popup_pref"></b>ã€€ã€€<a onClick={close}>Close</a></p>
                            <p>
                                <label><input type="radio" name="popup" onChange={button} value="popup,gender"></input><em>æ€§åˆ¥</em></label>
                                <label><input type="radio" name="popup" onChange={button} value="popup,age" id="popupradio"></input><em>å¹´é½¢</em></label>
                                <label><input type="radio" name="popup" onChange={button} value="popup,status"></input><em>ä½•å›ç›®</em></label>
                            </p>
                            <div id="map1"></div>
                        </div>
                        <p className="left">
                            <a target="_blank" href="https://cio.go.jp/c19vaccine_dashboard">æ”¿åºœã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</a><br></br>
                            <a target="_blank" href="https://www.kantei.go.jp/jp/headline/kansensho/vaccine.html">å®˜é‚¸ã‚‚Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ãŒå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ãªã—ã€‚</a><br></br>
                            <a target="_blank" href="https://www.soumu.go.jp/main_sosiki/jichi_gyousei/daityo/jinkou_jinkoudoutai-setaisuu.html">äººå£ãƒ‡ãƒ¼ã‚¿ã¯ä»¤å’Œ3å¹´1æœˆ1æ—¥ä½æ°‘åŸºæœ¬å°å¸³ã‹ã‚‰ã€‚</a><br></br>
                            <a target="_blank" href="https://mainichi.jp/articles/20210418/k00/00m/040/107000c">#ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ã‚ˆã‚Šã‚‚ã“ã£ã¡ã®ãƒ¬ãƒ¼ã‚¹ã®æ–¹ãŒç››ã‚Šä¸ŠãŒã‚‹ã«æ±ºã¾ã£ã¦ã‚‹ã ã‚</a><br></br>
                            <a target="_blank" href="https://www.jacom.or.jp/column/2021/05/210506-51058.php">#å¸‚ç”ºæ‘åˆ¥ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®è€…æ•°APIã‚’å…¬é–‹ã—ã¦ğŸ’•</a><br></br>
                            <a target="_blank" href="https://mstdn.beer/@onekodate">ãŠå•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰ã¾ã§ã€æ°—è»½ã«å ±å‘Šè¦æœ›ãã ã•ã„ã€‚</a><br></br>
                            <a target="_blank" href="https://github.com/onekodate/vaccination">ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰https://github.com/onekodate/vaccination</a><br></br>
                            <a target="_blank" href="https://lets-go-vaccine-jp.vercel.app">å‚è€ƒã«ã—ãŸã‚‚ã®https://lets-go-vaccine-jp.vercel.app/</a>
                        </p>
                    </div>
                </div>
                <a id="download"></a>
            </div>
        );
    }else return (<div>Loading...</div>);
}

export default Home;